# 解决的问题

对于一些功能繁杂的项目，需要一个合理的架构来解决分与合的问题，我们往往发现拆分一个项目容易，然而如何把拆分出来的子项目，合理有效的组合到一个项目中却总是不那么完美，尤其对于前端开发来说，还需要考虑到性能优化问题。拿联想商城或淘宝首页来讲：

页面包含很多功能，如搜索，登录等，然而这些功能往往都有其他团队来完成，如何引用其他团队开发的这些功能变成了问题。常规的做法可能是，需要什么JS或CSS，直接引用对应的JS或CSS文件，那么问题来了

* 页面每多引用一个资源文件，都会增加一个网络请求，带来的问题就是增加用户等待页面渲染的时间。

面对这个问题，有人说可以合并所有的JS/CSS文件（或者利用Nginx concat模块合并），或者通过模块化加载，就可以避免页面中引用多个JS/CSS文件问题了，那么这样做的问题是什么呢？

* 不同的项目如果想通过构建合并文件，那只能每次把别的项目的文件给get下来，然后进行合并，这样增加了不必要的开销,还不如通过concat模块处理呢。
* 如果采用模块化加载，在加载之前这些功能是不可用的，对于一些基础功能是不适合模块化异步加载的。
*  以上各种方式都要面临一个问题：由于这些项目是由别的团队开发（隶属于不同的工程），如果这个项目频繁发版，版本变了，怎么办？这样的话我们就不得不频繁的更改我们的配置，加载新版的组件,而且需要重新发版，不仅浪费时间而且增加项目风险。
* 当然如果引用的项目发版时版本和路径不变，或许可以解决问题，那么又会有另一个问题，如果解决缓存问题，CDN呢？

# 解决方案

#### 碎片化管理(方案1)

对于静态资源来说，Nginx绝对是当前最好的选择:

* 开启SSI，通过include方式，可以在任何html页面引用其他碎片文件(html,inc等);
    <!--#include file="inc/header.inc" -->
* 开启concat模块，可以自动的将多个css文件或js文件放在一次请求里面合并输出;
    <script type="text/javascript" src="http://static.pkmyself.com/??dir1/js/a.js,dir2/b.js"></script>

这样我们可以要求任何前端项目，在构建发布时都要生成一个碎片文件，这个文件里面包含发布后静态资源(JS/CSS)的相对路径,其他项目在引用时，可以通过include的方式引用。

以搜索为例，构建时生成如下一个碎片文件search.inc(**set是nginx ssi模块设置变量的方法,可以在其他地方通过echo的方式输出这些变量**)

    <!--#set var="searchcss" value="/search/1.0.0/css/search.css"-->
    <!--#set var="searchjs" value="/search/1.0.0/js/search.js"-->

当我们首页需要引用时，可以通过include的方式引用这个碎片文件,在需要的地方输出（echo）对应的文件的路径，以下方式是通过nginx cocat模块对对个JS自动合并

    <!--#include file="serch.inc" -->
    <script type="text/javascript" src="http://static.pkmyself.com/??<!--echo name='searchjs' -->"></script>

这样以来，不管其他项目如何构建改变文件版本或类型，引用页面均不需要改变配置文件重新发发版，最多需要做的可能就是刷一下CDN而已。

#### 构建查找（方案2）

这个方案同样需要所有项目在构建时输出构建文档（json）格式并发布到可访问的地址，指明不同静态资源的最新发布路径。任何一个项目引用其他项目时，需要通过查找相应项目的构建文件，替换最新的静态资源路径。

这种方案的最大问题就是当其他项目重新发版时，如果想引用新功能，也需要重新发版，所以不是很值得推荐,以印象中之前facebook采用的就是类似的这种方案。

# 模板

这个项目是针对以上解决方案1的具体实现，包含多环境发布的基本构建，可以作为标准模板使用,同时方便本地调试。

#### 环境要求

Tengine，开启ssi，concat模块，修改mime.types，增加text/html的inc支持:`text/html                   html htm shtml inc;`

